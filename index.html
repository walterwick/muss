<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Offline M√ºzik √áalar</title>
  <link rel="manifest" href="manifest.json">
  <style>
    /* √ñnceki stil kurallarƒ± aynen kalƒ±yor */
    :root { /* ... */ }
    body { /* ... */ }
    header { /* ... */ }
    .music-list { /* ... */ }
    .music-item { /* ... */ }
    .player-container { /* ... */ }
    /* Diƒüer stiller aynƒ± */
  </style>
</head>
<body>
  <header>
    <h1>üéµ Offline M√ºzik √áalar</h1>
  </header>
  
  <div class="music-list" id="musicList">
    <div class="loading">M√ºzik listesi y√ºkleniyor...</div>
  </div>

  <div class="player-container">
    <div class="custom-controls">
      <div class="now-playing">
        <img src="placeholder-art.png" class="album-art" id="albumArt">
        <div class="song-info">
          <div class="song-title" id="songTitle">Se√ßili ≈üarkƒ± yok</div>
          <div class="artist" id="artist">‚Äî</div>
        </div>
      </div>
      
      <input type="range" id="progress" value="0">
      
      <div class="controls">
        <button id="prevBtn">‚èÆ</button>
        <button id="playPauseBtn">‚ñ∂</button>
        <button id="nextBtn">‚è≠</button>
        <input type="range" id="volume" min="0" max="1" step="0.1" value="1">
      </div>
    </div>
  </div>

  <audio id="audioPlayer"></audio>

  <script>
    const CACHE_NAME = 'music-player-v2';
    const apiUrl = "https://mus-1sm.pages.dev/";
    const musicListContainer = document.getElementById("musicList");
    const audioPlayer = document.getElementById("audioPlayer");
    let currentTrackIndex = 0;
    let musicItems = [];

    // Service Worker Kaydƒ±
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(registration => {
          console.log('Service Worker kaydedildi:', registration.scope);
        })
        .catch(error => {
          console.log('Service Worker kaydƒ± ba≈üarƒ±sƒ±z:', error);
        });
    }

    async function fetchMusicList() {
      try {
        const cache = await caches.open(CACHE_NAME);
        const [cachedResponse, networkResponse] = await Promise.all([
          cache.match(apiUrl),
          fetch(apiUrl).catch(() => null)
        ]);

        // √ñnbellekten veya aƒüdan veri i≈üleme
        if (networkResponse?.ok) {
          await cache.put(apiUrl, networkResponse.clone());
          processMusicList(await networkResponse.text());
        } else if (cachedResponse) {
          processMusicList(await cachedResponse.text());
        } else {
          throw new Error('M√ºzik listesi alƒ±namadƒ±');
        }
      } catch (error) {
        showError(error);
      }
    }

    function processMusicList(htmlText) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlText, "text/html");
      musicItems = Array.from(doc.querySelectorAll("a"))
        .filter(link => link.href.endsWith('.mp3'))
        .map(link => ({
          name: formatFileName(link.textContent),
          url: apiUrl + link.getAttribute('href')
        }));

      if (musicItems.length > 0) {
        renderMusicList();
        initPlayer();
        preCacheFirstSongs();
      }
    }

    async function preCacheFirstSongs() {
      const cache = await caches.open(CACHE_NAME);
      const urlsToCache = musicItems.slice(0, 5).map(item => item.url);
      
      urlsToCache.forEach(async url => {
        if (!(await cache.match(url))) {
          await cache.add(url);
        }
      });
    }

    function formatFileName(name) {
      return decodeURIComponent(name)
        .replace(/\.mp3$/i, '')
        .replace(/[-_]/g, ' ')
        .trim();
    }

    function renderMusicList() {
      musicListContainer.innerHTML = musicItems.map((item, index) => `
        <div class="music-item ${index === currentTrackIndex ? 'active' : ''}" 
             data-index="${index}" 
             onclick="playMusic(${index})">
          ${item.name}
        </div>
      `).join('');
    }

    async function playMusic(index) {
      currentTrackIndex = index;
      const track = musicItems[index];
      
      try {
        const cache = await caches.open(CACHE_NAME);
        const cachedAudio = await cache.match(track.url);
        
        audioPlayer.src = cachedAudio ? 
          URL.createObjectURL(await cachedAudio.blob()) : 
          track.url;
        
        audioPlayer.play();
        updateTrackInfo(track);
        cacheMusicFile(track.url);
      } catch (error) {
        console.error('√áalma hatasƒ±:', error);
      }
    }

    async function cacheMusicFile(url) {
      const cache = await caches.open(CACHE_NAME);
      if (!(await cache.match(url))) {
        await cache.add(url);
      }
    }

    function updateTrackInfo(track) {
      document.getElementById('songTitle').textContent = track.name;
      document.getElementById('artist').textContent = "Sanat√ßƒ±";
      renderMusicList();
    }

    function showError(error) {
      musicListContainer.innerHTML = `
        <div class="error">
          ‚ùå ${error.message}
          <button onclick="location.reload()">Tekrar Dene</button>
        </div>
      `;
    }

    // Oynatƒ±cƒ± kontrolleri
    function initPlayer() {
      audioPlayer.addEventListener('timeupdate', updateProgress);
      audioPlayer.addEventListener('ended', playNext);
      
      document.getElementById('prevBtn').addEventListener('click', playPrev);
      document.getElementById('nextBtn').addEventListener('click', playNext);
      document.getElementById('playPauseBtn').addEventListener('click', togglePlay);
      document.getElementById('progress').addEventListener('input', seek);
      document.getElementById('volume').addEventListener('input', updateVolume);

      // Klavye kontrolleri
      document.addEventListener('keydown', handleKeyPress);
      
      audioPlayer.volume = localStorage.getItem('volume') || 1;
      document.getElementById('volume').value = audioPlayer.volume;
    }

    function togglePlay() {
      audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
      document.getElementById('playPauseBtn').textContent = 
        audioPlayer.paused ? '‚ñ∂' : '‚è∏';
    }

    function updateProgress() {
      const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100 || 0;
      document.getElementById('progress').value = progress;
    }

    function seek(e) {
      audioPlayer.currentTime = (e.target.value * audioPlayer.duration) / 100;
    }

    function updateVolume(e) {
      audioPlayer.volume = e.target.value;
      localStorage.setItem('volume', e.target.value);
    }

    function playNext() {
      currentTrackIndex = (currentTrackIndex + 1) % musicItems.length;
      playMusic(currentTrackIndex);
    }

    function playPrev() {
      currentTrackIndex = (currentTrackIndex - 1 + musicItems.length) % musicItems.length;
      playMusic(currentTrackIndex);
    }

    function handleKeyPress(e) {
      switch(e.code) {
        case 'Space': togglePlay(); e.preventDefault(); break;
        case 'ArrowRight': audioPlayer.currentTime += 5; break;
        case 'ArrowLeft': audioPlayer.currentTime -= 5; break;
        case 'MediaTrackNext': playNext(); break;
        case 'MediaTrackPrevious': playPrev(); break;
      }
    }

    // Uygulamayƒ± ba≈ülat
    fetchMusicList();
  </script>
</body>
</html>
